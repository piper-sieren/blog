<!DOCTYPE html>
<html lang="en"><head>
    <title>Piper Williams | Blog</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content="#000084" />
    <link rel="icon" href="http://www.piperwilliams.work/favicon.ico">
    <link rel="canonical" href="http://www.piperwilliams.work">
    
    
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"></button>
            <a class="brand" href="http://www.piperwilliams.work">Piper Williams | Blog</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                    
                        
                            <li>
                                <a href="/about/">
                                    
                                    <span>About</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/post/">
                                    
                                    <span>All posts</span>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>
</nav><div id="content" class="container">

<div class="row-fluid navmargin">
    <div class="page-header">
        <h1>Use a Windows VM system-assigned managed identity to access Azure Storage via a SAS credential - Wed, Feb 10, 2021</h1>
    </div>
    <p class="lead">Use a Windows VM system-assigned managed identity to access Azure Storage via a SAS credential</p>
    <h2 id="prerequisites">Prerequisites</h2>
<ol>
<li>
<p>Assigning TLS1.2 to Storage Account and VM</p>
</li>
<li>
<p>Adding the VM to the firewall subnet inclusions</p>
</li>
<li>
<p>Create a System Managed Identity and assign to VM</p>
</li>
<li>
<p>Give that System Managed Identity RBAC over the storage account</p>
</li>
</ol>
<h2 id="azure-powershell-modules">Azure PowerShell Modules</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>Install-Module AzureRM 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Install-Module Azure -AllowClobber 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Install-Module Az -AllowClobber
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#AllowClobber flag removes the overlap between AzureRM, Az, and Azure PS Modules’ conflicting command names. </span></span></code></pre></div>
<h2 id="powershell-script">PowerShell Script</h2>
<h4 id="tls12-can-be-set-it-the-portal-settings-as-well--following-command-must-have-admin-privs">TLS1.2 can be set it the portal settings as well – following command must have Admin privs.</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>  [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12</span></span></code></pre></div>
<h4 id="the-purpose-of-these-self-assigned-link-local-addresses-is-to-facilitate-communication-with-other-hosts-within-the-subnet-even-in-the-absence-of-external-address-configuration-via-manual-input-or-dhcp-unlike-in-ipv6-implementation-of-ipv4-link-local-addresses-is-recommended-only-in-the-absence-of-a-normal-routable-address">The purpose of these self-assigned link-local addresses is to facilitate communication with other hosts within the subnet even in the absence of external address configuration (via manual input or DHCP). Unlike in IPv6, implementation of IPv4 link-local addresses is recommended only in the absence of a normal, routable address.</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>$response = Invoke-WebRequest -Uri &#39;http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01<span style="color:#960050;background-color:#1e0010">&amp;</span>resource=https%3A%2F%2Fmanagement.azure.com%2F&#39; -Method GET -Headers @{Metadata=&#34;true&#34;}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$content = $response.Content | ConvertFrom-Json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ArmToken = $content.access_token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$params = @{canonicalizedResource=&#34;/&lt;<span style="color:#f92672">container</span> <span style="color:#a6e22e">name</span>&gt;/&lt;<span style="color:#f92672">storage</span> <span style="color:#a6e22e">account</span>&gt;/&lt;<span style="color:#f92672">blob</span> <span style="color:#a6e22e">name</span>&gt;&#34;;signedResource=&#34;c&#34;;signedPermission=&#34;rcw&#34;;signedProtocol=&#34;https&#34;;signedExpiry=&#34;&lt;<span style="color:#f92672">signed</span> <span style="color:#a6e22e">expiry</span>&gt;&#34;}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$jsonParams = $params | ConvertTo-Json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$sasResponse = Invoke-WebRequest -Uri https://management.azure.com/subscriptions/&lt;<span style="color:#f92672">subscription</span>&gt;/resourceGroups/&lt;<span style="color:#f92672">resource</span> <span style="color:#a6e22e">group</span>&gt; /providers/Microsoft.Storage/storageAccounts/&lt;<span style="color:#f92672">storage</span> <span style="color:#a6e22e">account</span>&gt;/listServiceSas/?api-version=2017-06-01 -Method POST -Body $jsonParams -Headers @{Authorization=&#34;Bearer $ArmToken&#34;}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$sasContent = $sasResponse.Content | ConvertFrom-Json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$sasCred = $sasContent.serviceSasToken
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ctx = New-AzStorageContext -StorageAccountName a3dvcseburpstr01 -SasToken $sasCred</span></span></code></pre></div>
<h4 id="the-following-function-uploads-a-blank-test-file-to-the-blob-container">The following function uploads a blank test file to the blob container</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>Set-AzStorageBlobContent -File test.txt -Container &lt;<span style="color:#f92672">container</span> <span style="color:#a6e22e">name</span>&gt; -Blob &lt;<span style="color:#f92672">blob</span> <span style="color:#a6e22e">name</span>&gt;-Context $ctx</span></span></code></pre></div>
<h2 id="terminology">Terminology</h2>
<p><strong>SAS Credential:</strong> A Service SAS provides the ability to grant limited access to objects in a storage account, for limited time and a specific service (in our case, the blob service), without exposing an account access key.
<strong>PowerShell Module:</strong> A module is a package that contains PowerShell members, such as cmdlets, providers, functions, workflows, variables, and aliases. The members of this package can be implemented in a PowerShell script, a compiled DLL, or a combination of both. These files are usually grouped together in a single directory.
<strong>Managed Identities:</strong> On Azure, managed identities eliminate the need for developers having to manage credentials by providing an identity for the Azure resource in Azure AD and using it to obtain Azure Active Directory (Azure AD) tokens. This also helps accessing Azure Key Vault where developers can store credentials in a secure manner. Managed identities for Azure resources solve this problem by providing Azure services with an automatically managed identity in Azure AD.</p>
<h4 id="tls12-why-use-tls-12-with-configuration-manager">TLS1.2: Why use TLS 1.2 with Configuration Manager?</h4>
<p>TLS 1.2 is more secure than the previous cryptographic protocols such as SSL 2.0, SSL 3.0, TLS 1.0, and TLS 1.1. Essentially, TLS 1.2 keeps data being transferred across the network more secure.</p>
<h2 id="reference-documents--videos">Reference Documents &amp; Videos</h2>
<ol>
<li>
<p><a href="https://www.youtube.com/watch?v=3Q0jG1Doa-s&amp;t=596s">Getting started with PowerShell for Azure</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/tutorial-windows-vm-access-storage-sas">Tutorial: Use a Windows VM system-assigned managed identity to access Azure Storage via a SAS credential</a></p>
</li>
</ol>

    <h4><a href="http://www.piperwilliams.work">Back to Home</a></h4>
</div>


        </div><footer class="container">
    <hr class="soften">
    <p>
&copy; 

    

<span id="thisyear">2023</span>


</p>
    <p class="text-center">
        
        
        <a href="https://www.linkedin.com/in/pswnr9/">Linkedin</a> 
        <a href="https://github.com/piper-sieren">GitHub</a> 
        
    </p>
</footer>

</body><link rel="stylesheet" href="/css/bootstrap.css">
<link rel="stylesheet" href="/css/bootstrap-responsive.css">
<link rel="stylesheet" href="/css/style.css">

<script src="/js/jquery.js"></script>
<script src="/js/bootstrap-386.js"></script>
<script src="/js/bootstrap-transition.js"></script>
<script src="/js/bootstrap-alert.js"></script>
<script src="/js/bootstrap-modal.js"></script>
<script src="/js/bootstrap-dropdown.js"></script>
<script src="/js/bootstrap-scrollspy.js"></script>
<script src="/js/bootstrap-tab.js"></script>
<script src="/js/bootstrap-tooltip.js"></script>
<script src="/js/bootstrap-popover.js"></script>
<script src="/js/bootstrap-button.js"></script>
<script src="/js/bootstrap-collapse.js"></script>
<script src="/js/bootstrap-carousel.js"></script>
<script src="/js/bootstrap-typeahead.js"></script>
<script src="/js/bootstrap-affix.js"></script>
<script>
    _386 = { 
        fastLoad: false ,
        onePass: false , 
        speedFactor: 1 
    };

    
    function ThisYear() {
        document.getElementById('thisyear').innerHTML = new Date().getFullYear();
    };
</script>
</html>
